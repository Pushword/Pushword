#!/bin/bash -e

# Locally link js-helper
# cd packages/js-helper; yarn link; cd ../core; yarn link @pushword/js-helper; cd ../../

cd packages/skeleton
rm var/app.db|| true
rm -rf var/sessions|| true
rm -rf media|| true
rm -rf static|| true
rm -f config/users.yaml|| true
rm -rf /tmp/com.github.pushword.pushword/tests/var/dev/log/version|| true
cp -r media~ media

echo "Clearing cache..."
php bin/console cache:clear --no-warmup -q

echo "Creating database schema..."
php bin/console doctrine:schema:create -q

echo "Loading fixtures..."
php bin/console doctrine:fixtures:load -q

echo "Caching images..."
php bin/console pw:image:cache -q &

echo "Installing assets..."
php bin/console assets:install --symlink --relative -q &

php bin/console pw:user:create admin@example.tld p@ssword ROLE_SUPER_ADMIN Admin
php bin/console pw:flat:user-sync

# Wait for background processes to finish
wait

# Wait for deferred export background process to complete
sleep 1  # Give time for PID file to be created
timeout=30
while [ -f var/flat-deferred-export.pid ] && [ $timeout -gt 0 ]; do
    sleep 0.5
    timeout=$((timeout - 1))
done
sleep 1  # Extra wait to ensure export is fully complete

cd ../..

# Remove id lines from docs content (they are auto-generated by deferred export)
find packages/docs/content -name "*.md" -exec sed -i '/^id: [0-9]*$/d' {} \;
# Remove id column from CSV files (only if first column is 'id')
for csv in packages/docs/content/index.csv packages/docs/content/en/index.csv packages/docs/content/redirection.csv; do
    if [ -f "$csv" ] && head -1 "$csv" | grep -q "^id,"; then
        cut -d',' -f2- "$csv" > "$csv.tmp" && mv "$csv.tmp" "$csv"
    fi
done
# Delete conversation.csv (demo data, gitignored)
rm -f packages/docs/content/conversation.csv