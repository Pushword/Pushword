#!/bin/bash -e

# Check that all code is committed before running the script
check_git_status() {
    # Check for uncommitted changes
    if ! git diff-index --quiet HEAD --; then
        echo "❌ Error: There are uncommitted changes in your repository."
        echo "Please commit all your changes before running generate-docs."
        echo ""
        echo "Modified files:"
        git diff --name-status
        exit 1
    fi

    # Check for untracked files (excluding those ignored by .gitignore)
    if [ -n "$(git ls-files --others --exclude-standard)" ]; then
        echo "❌ Error: There are untracked files in your repository."
        echo "Please add and commit all necessary files before running generate-docs."
        echo ""
        echo "Untracked files:"
        git ls-files --others --exclude-standard
        exit 1
    fi

    echo "✅ All files are committed. Generating documentation..."
}

check_git_status

#composer reset-skeleton

# function restoreData {
#     echo "restore data..."
#      if [[ $CURRENT_DIR = 'packages/skeleton' ]]
#     then
#         cd ../../
#     fi
#     #bash ./.scripts/data-restore no-docs
# }
# trap restoreData EXIT
#bash ./.scripts/data-preserve no-docs

php ./.scripts/generate-docs-assets


CURRENT_DIR='packages/skeleton'
cd packages/skeleton

php bin/console pw:flat:sync pushword.piedweb.com --mode=import --no-backup && php bin/console pw:static pushword.piedweb.com

cd ../../
# Syncing with docs branch and sending to dist

git branch -D docs || true

git checkout --orphan docs

git rm -rf .

# Remove everything except docs and .git directories
find . -mindepth 1 -maxdepth 1 ! -name 'docs' ! -name '.git' -exec rm -rf {} +
rm -rf .git-hooks 2>/dev/null || true
rm -rf .github 2>/dev/null || true
rm -rf .scripts 2>/dev/null || true
rm -rf .phpunit.cache 2>/dev/null || true
rm -rf .vscode 2>/dev/null || true
rm -f .gitignore 2>/dev/null || true
find . -mindepth 1 -maxdepth 1 -name '.*' -type f -exec rm -f {} + 2>/dev/null || true

git add docs/*

git commit -m 'update docs'

git push origin docs --force

git checkout main

git stash || true

composer update -q && composer reset
