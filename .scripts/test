#!/bin/bash -e

START_TIME=$(date +%s)

export TEST_RUN_ID="${TEST_RUN_ID:-$$}"
export PANTHER_CHROME_ARGUMENTS="--headless --disable-gpu --disable-dev-shm-usage --no-sandbox --user-data-dir=/tmp/panther-chrome-${TEST_RUN_ID}"
export LOCK_DSN="flock:///tmp/com.github.pushword.pushword/tests/${TEST_RUN_ID}/locks"

function print_elapsed {
    local end_time=$(date +%s)
    local elapsed=$((end_time - START_TIME))
    local minutes=$((elapsed / 60))
    local seconds=$((elapsed % 60))
    echo ""
    echo -e "\033[1;32m✓ Total time: ${minutes}m ${seconds}s\033[0m"
}

function cleanup {
    pkill -f chromedriver 2>/dev/null || true
    pkill -f 'chrome.*headless' 2>/dev/null || true
    rm -rf "/tmp/com.github.pushword.pushword/tests/${TEST_RUN_ID}"
    # Clean up paratest worker dirs (e.g. ${TEST_RUN_ID}-w1, ${TEST_RUN_ID}-w2, ...)
    rm -rf /tmp/com.github.pushword.pushword/tests/${TEST_RUN_ID}-w*
    rm -rf "/tmp/panther-chrome-${TEST_RUN_ID}"
    rm -rf ".phpunit.cache-${TEST_RUN_ID}"
}

function cleanupAndComposerUpdate {
    cleanup
    composer update
}

function step {
    echo ""
    echo -e "\033[1;34m→ $1\033[0m"
}

trap cleanup EXIT

# Install nodejs dependencies
[ -d "node_modules" ] || yarn

FILTER_ARG=""
NO_PARALLEL=0
for arg in "$@"; do
    if [ "$arg" = "--no-parallel" ]; then
        NO_PARALLEL=1
    fi
done

if [ "$1" = "--filter" ] && [ -n "$2" ]; then
    FILTER_ARG="--filter $2"
elif [ "$1" != "full" ] && [ "$1" != "--no-parallel" ] && [ -n "$1" ]; then
    FILTER_ARG="--filter $1"
fi

if [ "$1" = "full" ]; then
    trap cleanupAndComposerUpdate EXIT

    step "Starting test-installer in background"
    INSTALLER_LOG=$(mktemp)
    ./.scripts/test-installer --quiet > "$INSTALLER_LOG" 2>&1 &
    INSTALLER_PID=$!

    step "Starting monorepo validation in background"
    MONOREPO_LOG=$(mktemp)
    composer validate-monorepo > "$MONOREPO_LOG" 2>&1 &
    MONOREPO_PID=$!

    step "composer update --prefer-lowest"
    composer update --prefer-lowest

    step "Running PHPUnit (prefer-lowest)"
    PHPUNIT_EXIT=0
    XDEBUG_MODE=off php -dxdebug.mode=off vendor/bin/phpunit --testdox --no-progress --colors=always --stop-on-failure --debug --no-cache-result $FILTER_ARG || PHPUNIT_EXIT=$?

    step "Waiting for monorepo validation"
    MONOREPO_EXIT=0
    wait $MONOREPO_PID || MONOREPO_EXIT=$?
    cat "$MONOREPO_LOG"
    rm -f "$MONOREPO_LOG"

    if [ $MONOREPO_EXIT -ne 0 ]; then
        echo "validate-monorepo FAILED (exit $MONOREPO_EXIT)"
        PHPUNIT_EXIT=$MONOREPO_EXIT
    fi

    step "Waiting for test-installer"
    INSTALLER_EXIT=0
    wait $INSTALLER_PID || INSTALLER_EXIT=$?
    cat "$INSTALLER_LOG"
    rm -f "$INSTALLER_LOG"

    if [ $INSTALLER_EXIT -ne 0 ]; then
        echo "test-installer FAILED (exit $INSTALLER_EXIT)"
        print_elapsed
        exit 1
    fi

    print_elapsed
    exit $PHPUNIT_EXIT
else
    if [ -z "$FILTER_ARG" ]; then
        step "Starting test-installer in background"
        INSTALLER_LOG=$(mktemp)
        ./.scripts/test-installer --quiet > "$INSTALLER_LOG" 2>&1 &
        INSTALLER_PID=$!

        step "Starting monorepo validation in background"
        MONOREPO_LOG=$(mktemp)
        composer validate-monorepo > "$MONOREPO_LOG" 2>&1 &
        MONOREPO_PID=$!
    fi

    # Pre-warm Symfony container cache so workers don't each compile it
    step "Warming container cache"
    PUSHWORD_TEST_MEDIA_DIR=/dev/null PUSHWORD_TEST_DATABASE_URL=sqlite:///dev/null PUSHWORD_TEST_FLAT_CONTENT_DIR=/dev/null \
        XDEBUG_MODE=off php -dxdebug.mode=off packages/skeleton/bin/console cache:warmup --env=test --quiet 2>/dev/null || true

    PHPUNIT_EXIT=0
    if [ -z "$FILTER_ARG" ] && [ $NO_PARALLEL -eq 0 ]; then
        step "Running PHPUnit (parallel)"
        XDEBUG_MODE=off php -dxdebug.mode=off vendor/bin/paratest --processes=auto --testdox --no-progress --colors=always --cache-directory=.phpunit.cache-${TEST_RUN_ID} || PHPUNIT_EXIT=$?
    else
        step "Running PHPUnit"
        XDEBUG_MODE=off php -dxdebug.mode=off vendor/bin/phpunit --testdox --no-progress --colors=always --stop-on-failure --cache-directory=.phpunit.cache-${TEST_RUN_ID} $FILTER_ARG || PHPUNIT_EXIT=$?
    fi

    if [ -z "$FILTER_ARG" ]; then
        step "Waiting for monorepo validation"
        MONOREPO_EXIT=0
        wait $MONOREPO_PID || MONOREPO_EXIT=$?
        cat "$MONOREPO_LOG"
        rm -f "$MONOREPO_LOG"

        if [ $MONOREPO_EXIT -ne 0 ]; then
            echo "validate-monorepo FAILED (exit $MONOREPO_EXIT)"
            PHPUNIT_EXIT=$MONOREPO_EXIT
        fi

        step "Waiting for test-installer"
        INSTALLER_EXIT=0
        wait $INSTALLER_PID || INSTALLER_EXIT=$?
        cat "$INSTALLER_LOG"
        rm -f "$INSTALLER_LOG"

        if [ $INSTALLER_EXIT -ne 0 ]; then
            echo "test-installer FAILED (exit $INSTALLER_EXIT)"
        fi
    fi

    print_elapsed
    exit $PHPUNIT_EXIT
fi
