#!/bin/bash -e

function restoreDataAndComposerDependencies {
    echo 'restore data and dependencies...'
    bash ./.scripts/data-restore
    composer update
}

function restoreData {
    echo 'restore data...'
    bash ./.scripts/data-restore
}

trap restoreData EXIT
sh ./.scripts/data-preserve


#XDEBUG_MODE=off php -dxdebug.mode=off
#  --log-junit report.xml
FILTER_ARG=""
if [ "$1" = "--filter" ] && [ -n "$2" ]
then
    FILTER_ARG="--filter $2"
elif [ "$1" != "full" ] && [ -n "$1" ]
then
    # If first argument is not "full" and not empty, treat it as a filter
    FILTER_ARG="--filter $1"
fi

# Install nodejs dependencies
[ -d "node_modules" ] || yarn

# lsof -ti:9080 | xargs -r kill -9 2>/dev/null; pkill -f chromedriver 2>/dev/null; sleep 1

if [ "$1" = "full" ]
then
    trap restoreDataAndComposerDependencies EXIT
    composer update --prefer-lowest
    XDEBUG_MODE=off php -dxdebug.mode=off vendor/bin/phpunit --stop-on-failure --debug --no-cache-result --exclude-group panther $FILTER_ARG
    composer validate-monorepo
else
    vendor/bin/phpunit --stop-on-failure --exclude-group panther $FILTER_ARG
    # Only run validate-monorepo if no filter was applied (i.e., no arguments passed)
    if [ -z "$FILTER_ARG" ]
    then
        composer validate-monorepo
    fi
fi
#--debug
