#!/bin/bash -e

export TEST_RUN_ID="${TEST_RUN_ID:-$$}"
export PANTHER_CHROME_ARGUMENTS="--headless --disable-gpu --disable-dev-shm-usage --no-sandbox --user-data-dir=/tmp/panther-chrome-${TEST_RUN_ID}"
export LOCK_DSN="flock:///tmp/com.github.pushword.pushword/tests/${TEST_RUN_ID}/locks"

function cleanup {
    pkill -f chromedriver 2>/dev/null || true
    pkill -f 'chrome.*headless' 2>/dev/null || true
    rm -rf "/tmp/com.github.pushword.pushword/tests/${TEST_RUN_ID}"
    rm -rf "/tmp/panther-chrome-${TEST_RUN_ID}"
    rm -rf ".phpunit.cache-${TEST_RUN_ID}"
}

function cleanupAndComposerUpdate {
    cleanup
    composer update
}

function step {
    echo ""
    echo -e "\033[1;34mâ†’ $1\033[0m"
}

trap cleanup EXIT

# Install nodejs dependencies
[ -d "node_modules" ] || yarn

FILTER_ARG=""
if [ "$1" = "--filter" ] && [ -n "$2" ]; then
    FILTER_ARG="--filter $2"
elif [ "$1" != "full" ] && [ -n "$1" ]; then
    FILTER_ARG="--filter $1"
fi

if [ "$1" = "full" ]; then
    trap cleanupAndComposerUpdate EXIT

    step "Starting test-installer in background"
    INSTALLER_LOG=$(mktemp)
    ./.scripts/test-installer --quiet > "$INSTALLER_LOG" 2>&1 &
    INSTALLER_PID=$!

    step "composer update --prefer-lowest"
    composer update --prefer-lowest

    step "Running PHPUnit (prefer-lowest)"
    PHPUNIT_EXIT=0
    XDEBUG_MODE=off php -dxdebug.mode=off vendor/bin/phpunit --testdox --no-progress --colors=always --stop-on-failure --debug --no-cache-result $FILTER_ARG || PHPUNIT_EXIT=$?

    step "Validating monorepo"
    composer validate-monorepo || PHPUNIT_EXIT=$?

    step "Waiting for test-installer"
    INSTALLER_EXIT=0
    wait $INSTALLER_PID || INSTALLER_EXIT=$?
    cat "$INSTALLER_LOG"
    rm -f "$INSTALLER_LOG"

    if [ $INSTALLER_EXIT -ne 0 ]; then
        echo "test-installer FAILED (exit $INSTALLER_EXIT)"
        exit 1
    fi

    exit $PHPUNIT_EXIT
else
    if [ -z "$FILTER_ARG" ]; then
        step "Starting test-installer in background"
        INSTALLER_LOG=$(mktemp)
        ./.scripts/test-installer --quiet > "$INSTALLER_LOG" 2>&1 &
        INSTALLER_PID=$!
    fi

    step "Running PHPUnit"
    PHPUNIT_EXIT=0
    vendor/bin/phpunit --testdox --no-progress --colors=always --stop-on-failure --cache-directory=.phpunit.cache-${TEST_RUN_ID} $FILTER_ARG || PHPUNIT_EXIT=$?

    if [ -z "$FILTER_ARG" ]; then
        step "Validating monorepo"
        composer validate-monorepo || PHPUNIT_EXIT=$?

        step "Waiting for test-installer"
        INSTALLER_EXIT=0
        wait $INSTALLER_PID || INSTALLER_EXIT=$?
        cat "$INSTALLER_LOG"
        rm -f "$INSTALLER_LOG"

        if [ $INSTALLER_EXIT -ne 0 ]; then
            echo "test-installer FAILED (exit $INSTALLER_EXIT)"
        fi
    fi

    exit $PHPUNIT_EXIT
fi
