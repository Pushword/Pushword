{# @var review \Pushword\Conversation\Entity\Review #}


{% set anonymous = 'conversation.review.anonymous'|trans %}
{% set reviewAuthor = review.authorName|default(anonymous) %}

{% set reviewBody = review.content %}
{% set reviewBodyHtml = reviewBody|markdown %}


{% block review %}
<blockquote
    class="{{ reviewWrapperClass|default('text-lg mb-12') }}"
    x-data="{
        expanded: false,
        isTruncated: false,
        checkTruncation() {
            this.$nextTick(() => {
                const el = this.$refs.bodyText;
                if (!el) return;
                const tempEl = el.cloneNode(true);
                tempEl.style.position = 'absolute';
                tempEl.style.visibility = 'hidden';
                tempEl.style.height = 'auto';
                tempEl.style.maxHeight = 'none';
                tempEl.classList.remove('line-clamp-3');
                document.body.appendChild(tempEl);
                const actualHeight = tempEl.scrollHeight;
                const lineHeight = parseFloat(getComputedStyle(el).lineHeight) || parseFloat(getComputedStyle(el).fontSize) * 1.5;
                const maxHeight = lineHeight * 3;
                this.isTruncated = actualHeight > maxHeight;
                document.body.removeChild(tempEl);
            });
        }
    }"
    x-init="checkTruncation()"
>
    <div class="font-bold not-italic mb-3">
        {% if review.rating %}
            {% set ratingValue = review.rating %}
            {% set ratingValue = ratingValue > 5 ? 5 : ratingValue %}
            {% set ratingValue = ratingValue < 1 ? 1 : ratingValue %}
            <span class="text-yellow-500" aria-label="{{ ratingValue }}/5">
                {% for i in 1..5 %}
                    {% if i <= ratingValue %}
                        ★
                    {% else %}
                        ☆
                    {% endif %}
                {% endfor %}
            </span>
            &nbsp;&nbsp;
        {% endif %}
        {% if review.title %}
            <strong>{{ review.title }}</strong>
        {% endif %}
        {% if is_granted('ROLE_EDITOR') and review.id and class_exists('\\Pushword\\Admin\\PushwordAdminBundle') %}
            {% set editUrl = ea_url()
                .setController('Pushword\\Conversation\\Controller\\Admin\\ReviewCrudController')
                .setAction('edit')
                .setEntityId(review.id)
            %}
            <a href="{{ editUrl }}"
               class="inline-block bg-gray-500 rounded p-1 text-gray-50  hover:bg-gray-800 float-right"
               title="{% trans %}admin.review.edit{% endtrans %}">
                {{ svg('edit', {class: 'p-2 fill-current', style: 'width:12px'}) }}
                <span class="sr-only">{% trans %}admin.review.edit{% endtrans %}</span>
            </a>
        {% endif %}
    </div>
    <div
        x-ref="bodyText"
        class="italic prose-lg"
        :class="{ 'line-clamp-3': !expanded }"
    >
        {{ reviewBodyHtml|raw }}
    </div>
    <button
        type="button"
        @click="expanded = !expanded"
        class="mt-3 text-sm font-medium text-primary hover:text-primary/80 transition-colors"
        x-show="isTruncated"
    >
        <span x-show="!expanded">
            {% trans %}conversation.review.see_more{% endtrans %}
            <i class="fa-solid fa-chevron-down text-xs ml-1" aria-hidden="true"></i>
        </span>
        <span x-show="expanded" x-cloak>
            {% trans %}conversation.review.see_less{% endtrans %}
            <i class="fa-solid fa-chevron-up text-xs ml-1" aria-hidden="true"></i>
        </span>
    </button>
    <footer class="blockquote-footer mt-3 not-italic text-sm prose">
        <p>
            Commentaire envoyé par {{ reviewAuthor }}
            {% set source = review.getCustomProperty('source') %}
            {% if source %}
                sur <span>{{ source }}</span>.
            {% else %}
                .
            {% endif %}
        </p>
    </footer>
    {% if review.mediaList is not empty %}
        <div class="overflow-x-hidden md:overflow-x-auto w-full mt-4">
            {{ gallery(review.mediaList) }}
        </div>
    {% endif %}
</blockquote>
{% endblock %}
