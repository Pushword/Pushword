{# @var review \Pushword\Conversation\Entity\Review #}


{% set anonymous = 'conversationReviewAnonymous'|trans %}
{% set reviewAuthor = review.authorName|default(anonymous) %}

{% set reviewBody = review.content %}
{% set reviewMonth = review.createdAt|date('F') %}
{% set reviewBodyHtml = reviewBody|markdown %}


{% block review %}
<blockquote
  class="{{ reviewWrapperClass|default('text-lg mb-12') }}"
  x-data="{
    expanded: false,
    isTruncated: false,
    checkTruncation() {
      this.$nextTick(() => {
        const el = this.$refs.bodyText;
        if (!el) return;
        const tempEl = el.cloneNode(true);
        tempEl.style.position = 'absolute';
        tempEl.style.visibility = 'hidden';
        tempEl.style.height = 'auto';
        tempEl.style.maxHeight = 'none';
        tempEl.classList.remove('line-clamp-3');
        document.body.appendChild(tempEl);
        const actualHeight = tempEl.scrollHeight;
        const lineHeight = parseFloat(getComputedStyle(el).lineHeight) || parseFloat(getComputedStyle(el).fontSize) * 1.5;
        const maxHeight = lineHeight * 3;
        this.isTruncated = actualHeight > maxHeight;
        document.body.removeChild(tempEl);
      });
    }
  }"
  x-init="checkTruncation()"
>
  <div class="font-bold not-italic mb-3">
    {% if review.title %}
      <strong>{{ review.title }}</strong>
    {% endif %}
    {% if is_granted('ROLE_EDITOR') and review.id and class_exists('\\Pushword\\Admin\\PushwordAdminBundle') %}
      {% set editUrl = ea_url()
        .setController('Pushword\\Conversation\\Controller\\Admin\\ReviewCrudController')
        .setAction('edit')
        .setEntityId(review.id)
      %}
      <a href="{{ editUrl }}"
         class="inline-block rounded p-1 text-gray-300  hover:bg-gray-300 hover:text-gray-900 float-right"
         title="{% trans %}adminReviewEdit{% endtrans %}">
        {{ svg('edit', {class: 'fill-current', style: 'width:14px'}) }}
        <span class="sr-only">{% trans %}adminReviewEdit{% endtrans %}</span>
      </a>
    {% endif %}
  </div>
  <div class=" mt-3 not-italic text-sm prose">

    {% if review.rating %}
      {% set ratingValue = review.rating %}
      {% set ratingValue = ratingValue > 5 ? 5 : ratingValue %}
      {% set ratingValue = ratingValue < 1 ? 1 : ratingValue %}
      <span class="text-yellow-500" aria-label="{{ ratingValue }}/5">
        {% for i in 1..5 %}
          {% if i <= ratingValue %}
            ★
          {% else %}
            ☆
          {% endif %}
        {% endfor %}
      </span>
      &nbsp;&nbsp;
    {% endif %}

    <span class="inline-block">
      {% trans %}conversationReviewCommentSentBy{% endtrans %} {{ reviewAuthor }}

      {{ 'conversationReviewIn'|trans }} <span>{{ reviewMonth }}</span>
      {% set source = review.getCustomProperty('source') %}
      {% if source %}
        {{ 'conversationReviewOn'|trans }} <span>{{ _self.renderSource(source) }}</span>
      {% endif %}
    </span>
  </div>
  <div
    x-ref="bodyText"
    class="italic prose-lg mt-3"
    :class="{ 'line-clamp-3': !expanded }"
  >
    {{ reviewBodyHtml|raw }}
  </div>
  <button
    type="button"
    @click="expanded = !expanded"
    class="w-full text-center italic mt-3 text-sm text-gray-500 hover:text-gray-700 transition-colors cursor-pointer"
    x-show="isTruncated"
  >
    <span x-show="!expanded">
      {% trans %}conversationReviewSeeMore{% endtrans %} <span class="inline-block">▼</span>
    </span>
    <span x-show="expanded" x-cloak>
      {% trans %}conversationReviewSeeLess{% endtrans %} <span class="inline-block">▲</span>
    </span>
  </button>
  {% if review.mediaList is not empty %}
    <div class="overflow-x-hidden md:overflow-x-auto w-full mt-4">
      {% include view('/component/images_gallery.html.twig') with {
        images: review.mediaList,
        isReview: true
      } %}
    </div>
  {% endif %}
</blockquote>
{% endblock %}

{% macro renderSource(source) %}
  {% set sourceName =
  'tripa' in source? 'TripAdvisor' :
  'google' in source ? 'Google' :
  'maps.app.goo.gl' in source ? 'Google' :
  'facebook' in source ? 'Facebook' :
  'linkedin' in source ? 'LinkedIn' :
  'twitter' in source ? 'Twitter' :
  'instagram' in source ? 'Instagram' :
  'youtube' in source ? 'YouTube' :
  'pinterest' in source ? 'Pinterest' :
  'tiktok' in source ? 'TikTok'
    : 'Direct' %}

  {{ link(sourceName, source) }}
{% endmacro %}