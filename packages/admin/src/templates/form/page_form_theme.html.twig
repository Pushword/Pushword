{% extends '@EasyAdmin/crud/form_theme.html.twig' %}

{# WCAG 2.1 AA: Enhanced form_widget to add ARIA attributes for error states (WCAG 3.3.1, 4.1.2) #}
{% block form_widget_simple %}
    {% set hasErrors = errors|length > 0 %}
    {% set errorId = id ~ '_errors' %}

    {% if hasErrors %}
        {% set attr = attr|merge({
            'aria-invalid': 'true',
            'aria-describedby': (attr['aria-describedby'] is defined ? attr['aria-describedby'] ~ ' ' : '') ~ errorId
        }) %}
    {% endif %}

    {{ parent() }}
{% endblock %}

{# WCAG 2.1 AA: Enhanced form_errors with proper ARIA role for announcements #}
{% block form_errors %}
    {% if errors|length > 0 %}
        {% set errorClass = attr.errorClass is defined ? attr.errorClass : 'invalid-feedback d-block' %}
        <div id="{{ form.vars.id }}_errors" class="{{ errorClass }}" role="alert" aria-live="assertive">
            {% for error in errors %}
                <span class="form-error-message">{{ error.message }}</span>
            {% endfor %}
        </div>
    {% endif %}
{% endblock %}

{% block ea_form_fieldset_open_row %}
    {% set fieldset_has_header = form.vars.label or ea_icon or ea_help %}
    {% set css_class = ea_css_class ?? '' %}
    {% set is_pw_settings = css_class is not null and 'pw-settings-accordion' in css_class %}

    {% if is_pw_settings %}
        {% set panel_key = form.vars.attr['data-pw-panel-key'] ?? form.vars.name %}
        <div class="form-fieldset {{ not fieldset_has_header ? 'form-fieldset-no-header' }} {{ ea_css_class }}"
             data-pw-panel-key="{{ panel_key }}">
            <fieldset>
                {% if fieldset_has_header %}
                    <div class="form-fieldset-header {{ ea_help is not empty ? 'with-help' }} pw-settings-header">
                        <button type="button"
                                class="pw-settings-toggle"
                                aria-expanded="false"
                                aria-controls="content-{{ form.vars.name }}">
                            <span class="pw-settings-title">
                                {% if ea_icon %}
                                    <twig:ea:Icon name="{{ ea_icon }}" class="pw-settings-title-icon" />
                                {% endif %}
                                {{ form.vars.label|trans(domain: ea().i18n.translationDomain)|raw }}
                            </span>
                            <span class="pw-settings-chevron">
                                <svg viewBox="0 0 20 20" aria-hidden="true" focusable="false">
                                    <path d="M7.293 4.293a1 1 0 0 0 0 1.414L10.586 9 7.293 12.293a1 1 0 1 0 1.414 1.414l4-4a1 1 0 0 0 0-1.414l-4-4a1 1 0 0 0-1.414 0z"/>
                                </svg>
                            </span>
                        </button>

                        {% if ea_help %}
                            <div class="form-fieldset-help">{{ ea_help|trans(domain: ea().i18n.translationDomain)|raw }}</div>
                        {% endif %}
                    </div>
                {% endif %}

                <div id="content-{{ form.vars.name }}"
                     data-pw-panel-key="{{ panel_key }}"
                     class="form-fieldset-body {{ not fieldset_has_header ? 'without-header' }}"
                     style="display: none"
                     aria-hidden="true">
                    <div class="row">
    {% else %}
        {{ parent() }}
    {% endif %}
{% endblock ea_form_fieldset_open_row %}

{% block ea_form_fieldset_close_row %}
    {% set css_class = ea_css_class ?? '' %}
    {% set is_pw_settings = css_class is not null and 'pw-settings-accordion' in css_class %}

    {% if is_pw_settings %}
                    </div>
                </div>
            </fieldset>
        </div>
    {% else %}
        {{ parent() }}
    {% endif %}
{% endblock ea_form_fieldset_close_row %}
