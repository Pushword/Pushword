<div class="pw-draft-toggle d-flex align-items-center gap-2">
  <label class="form-check form-switch mb-0" id="pw-draft-toggle-wrapper">
    <input
      type="checkbox"
      class="form-check-input"
      id="pw-draft-toggle-switch"
      data-target-input="Page_publishedAt"
    >
  </label>
  <small class="text-muted mb-0" id="pw-draft-toggle-status">
    —
  </small>
  <button type="button" class="btn btn-sm btn-outline-secondary px-1" id="pw-schedule-btn" title="{{ 'adminSchedule'|trans }}">
    <i class="fa fa-clock"></i>
  </button>
</div>

<script>
(function() {
  'use strict';

  const toggleSwitch = document.getElementById('pw-draft-toggle-switch');
  const toggleWrapper = document.getElementById('pw-draft-toggle-wrapper');
  const targetInputSelector = toggleSwitch?.getAttribute('data-target-input');
  const targetInput = targetInputSelector ? document.getElementById(targetInputSelector) : null;
  const scheduleBtn = document.getElementById('pw-schedule-btn');

  if (!toggleSwitch || !targetInput) {
    return;
  }

  const statusText = document.getElementById('pw-draft-toggle-status');

  /**
   * Format a Date object to datetime-local format (YYYY-MM-DDTHH:mm)
   */
  function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
  }

  /**
   * Update toggle color class based on scheduled vs published
   */
  function updateToggleColor() {
    if (!toggleWrapper) return;

    toggleWrapper.classList.remove('pw-published-online', 'pw-scheduled');

    if (!toggleSwitch.checked) return;

    const date = new Date(targetInput.value);
    const now = new Date();
    if (date > now) {
      toggleWrapper.classList.add('pw-scheduled');
    } else {
      toggleWrapper.classList.add('pw-published-online');
    }
  }

  function updateToggleState() {
    const hasValue = targetInput.value.trim() !== '';
    toggleSwitch.checked = hasValue;

    if (statusText) {
      statusText.textContent = hasValue
        ? new Date(targetInput.value).toLocaleString('fr-FR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          })
        : '—';
    }

    updateToggleColor();
  }

  function handleToggleChange() {
    targetInput.value = toggleSwitch.checked ? formatDateTimeLocal(new Date()) : '';
    updateToggleState();
    targetInput.dispatchEvent(new Event('change', { bubbles: true }));
  }

  function handleScheduleClick() {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(9, 0, 0, 0);
    targetInput.value = formatDateTimeLocal(tomorrow);
    updateToggleState();
    targetInput.focus();
    targetInput.dispatchEvent(new Event('change', { bubbles: true }));
  }

  // Initialize toggle state
  updateToggleState();

  // Listen to toggle changes
  toggleSwitch.addEventListener('change', handleToggleChange);

  // Listen to schedule button
  if (scheduleBtn) {
    scheduleBtn.addEventListener('click', handleScheduleClick);
  }

  // Listen to target input changes (in case user manually changes the datetime)
  targetInput.addEventListener('change', updateToggleState);
  targetInput.addEventListener('input', updateToggleState);
})();
</script>
